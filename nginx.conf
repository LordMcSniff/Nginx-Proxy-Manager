# heavily inspired by https://github.com/jc21/docker-nginx-full
# which itself mostly uses openresty https://openresty.org/en/

# TODO: set correct domain
# TODO: lookup default nginx variables eg. $host, $request_uri, ...
domain=localhost

# disable deamon
# required, as its running as a docker container https://hub.docker.com/_/nginx
daemon off;
pid /run/nginx/nginx.pid;
user nginx;

worker_processes auto;

# Just-in-Time Compiler for regular expressions to speed-up their processing.
# dont know if i want this
# pcre_jit on;

error_log /data/logs/nginx/fallback_error.log warn;

# TODO: include modules
# include /etc/nginx/modules/*.conf;

events {
    # http://nginx.org/en/docs/ngx_core_module.html#worker_connections
    # default is 512. since this is a private development server,
    # no more than 3 people should use it at a time anyway
    worker_connections 32;
}

http {
    include /etc/nginx/mime.types;
    # idk what this even means, but everyone seems to use it
    default_type application/octet-stream;
    # TODO: 
    sendfile                      on; # on is default for docker nginx
	# server_tokens                 off;
	# tcp_nopush                    on;
	# tcp_nodelay                   on;
	# client_body_temp_path         /tmp/nginx/body 1 2;
	keepalive_timeout             90s; # 65 is default for docker nginx
	# proxy_connect_timeout         90s;
	# proxy_send_timeout            90s;
	# proxy_read_timeout            90s;
	# ssl_prefer_server_ciphers     on;
	gzip                          on;
	# proxy_ignore_client_abort     off;
	# client_max_body_size          2000m;
	# server_names_hash_bucket_size 1024;
	# proxy_http_version            1.1;
	# proxy_set_header              X-Forwarded-Scheme $scheme;
	# proxy_set_header              X-Forwarded-For $proxy_add_x_forwarded_for;
	# proxy_set_header              Accept-Encoding "";
	# proxy_cache                   off;
	# proxy_cache_path              /var/lib/nginx/cache/public  levels=1:2 keys_zone=public-cache:30m max_size=192m;
	# proxy_cache_path              /var/lib/nginx/cache/private levels=1:2 keys_zone=private-cache:5m max_size=1024m;


    log_format proxy '[$time_local] $upstream_cache_status $upstream_status $status - $request_method $scheme $host "$request_uri" [Client $remote_addr] [Length $body_bytes_sent] [Gzip $gzip_ratio] [Sent-to $server] "$http_user_agent" "$http_referer"\u001b[0m]';
	log_format standard '[$time_local] $status - $request_method $scheme $host "$request_uri" [Client $remote_addr] [Length $body_bytes_sent] [Gzip $gzip_ratio] "$http_user_agent" "$http_referer"';

    access_log /data/logs/nginx/fallback_access.log proxy;


    # dont know if i even need this.
    # Openresty auto gens this file. I don't.
	# http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver
	# include /etc/nginx/conf.d/include/resolvers.conf;


    map $host $forward_scheme {
        default http;
    }


    error_page 500 502 503 504 /5xx.html; #TODO: make global error page; point to maintanance page


    # TODO:
    # add auto redirect to https for all subdomains
    # include /etc/nginx/ssl.conf;


    # this incluedes all enabled packages, such as the manager API
    include /etc/nginx/routes/*.conf; 


	# original: "Real IP Determination" As in docker ip to real ip mapping?
    # http://nginx.org/en/docs/http/ngx_http_realip_module.html

	# Local subnets:
    # TODO:
	# set_real_ip_from 10.0.0.0/8;
	# set_real_ip_from 172.16.0.0/12; # Includes Docker subnet
	# set_real_ip_from 192.168.0.0/16;
	# # NPM generated CDN ip ranges:
	# include conf.d/include/ip_ranges.conf;
	# # always put the following 2 lines after ip subnets:
	# real_ip_header X-Real-IP;
	# real_ip_recursive on;


    # nginx-proxy-manager has 4 proxy "protocols" you can use
    # 3 where you just insert the necessary data in the web UI
    # /data/nginx/default_host
    # /data/nginx/proxy_host
    # /data/nginx/redirection_host
    # 
    # and one where you can add custom nginx config code 
    # ie /data/nginx/custom/custom
    # 
	# include /data/nginx/custom/http_top[.]conf;


    # i guess this is where the web configured proies would be populated to 
    # TODO:
	# Files generated by NPM
	# include /etc/nginx/conf.d/*.conf;
	# include /data/nginx/default_host/*.conf;
	# include /data/nginx/proxy_host/*.conf;
	# include /data/nginx/redirection_host/*.conf;
	# include /data/nginx/dead_host/*.conf;
	# include /data/nginx/temp/*.conf;


    # the custom directory doesnt exist in the docker container.
    # maybe it would be generated after some use, but i dont even know what for
	# Custom
	# include /data/nginx/custom/http[.]conf;
}


# TODO: 
# stream {
# 	# Files generated by NPM
# 	include /data/nginx/stream/*.conf;

# 	# Custom
# 	include /data/nginx/custom/stream[.]conf;
# }

# TODO:
# Custom
# include /data/nginx/custom/root[.]conf;
